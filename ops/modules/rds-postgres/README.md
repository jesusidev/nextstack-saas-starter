# rds-postgres module

Private, cost-conscious PostgreSQL RDS module aligned with ops/aws-architecture.md:
- Runs in private subnets (requires global stack with private subnets)
- Security Group allows ingress on 5432 only from specified SG(s) (e.g., app EC2 SG)
- Storage encrypted, backups enabled, Multi-AZ optional
- Password is always auto-generated; a Secrets Manager secret stores connection info (implemented via ops/modules/secrets-manager-secret)

## Inputs
- name_prefix (string)
- vpc_id (string)
- private_subnet_ids (list(string))
- allowed_security_group_ids (list(string)) â€” SGs allowed to connect (ingress on 5432)
- db_name (string, default "appdb")
- username (string, default "appuser")
- instance_class (string, default "db.t3.micro")
- allocated_storage (number, default 20)
- multi_az (bool, default false)
- engine_version (string, default "15.5")
- backup_retention_period (number, default 7)
- deletion_protection (bool, default false)
- skip_final_snapshot (bool, default true)
- apply_immediately (bool, default true)
- create_secret (bool, default true)
- tags (map(string))

## Outputs
- endpoint
- port
- db_name
- username
- instance_identifier
- db_arn
- secret_name (null if create_secret = false)
- secret_arn (null if create_secret = false)
- secret_id (null if create_secret = false)

## Notes
- Ensure your global stack creates private subnets (set create_private_subnets = true) and pass them via private_subnet_ids.
- NAT Gateway is not required for a basic private RDS unless you need outbound internet from private subnets.


## Password management and Secrets

- The database password is always auto-generated by this module via the random_password resource. There is no db_password input. The module stores the connection details (including the generated password) in AWS Secrets Manager using AWS-managed encryption (no extra KMS cost by default).
- Secret name pattern: <name_prefix>-rds-credentials. The module outputs secret_arn when create_secret = true.

### Retrieve credentials

CLI example:

```
aws secretsmanager get-secret-value \
  --secret-id <SECRET_ARN_OR_NAME> \
  --query SecretString --output text | jq -r '.'
```

Example output fields:
- engine, host, port, dbname, username, password, instance_id, arn

### App access to the secret

Ensure your compute (e.g., the EC2 instance role from ops/modules/ec2-app) has permission to read the specific secret. Example minimal IAM policy statement:

```
{
  "Effect": "Allow",
  "Action": [
    "secretsmanager:GetSecretValue"
  ],
  "Resource": "<RDS_SECRET_ARN>"
}
```

Tip: Use the rds_secret_arn output from the app stack when enable_rds = true.
